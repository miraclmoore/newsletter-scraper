# Story 1.7: AI Summarization

## Status
Draft

## Story
**As a** user,
**I want** to toggle AI summaries (headline + 3 bullets) for newsletter issues,
**so that** I can quickly understand content without reading full articles.

## Acceptance Criteria
1. User can enable/disable AI summaries in their account settings
2. System generates headline + 3 bullet point summaries using OpenAI GPT
3. Summaries are generated asynchronously and cached for performance
4. User sees summary toggle button on each newsletter item in dashboard
5. Summaries display prominently when enabled for an item
6. System respects token limits and caps requests per user/month
7. Failed summarization attempts are logged and show fallback message
8. Summary generation is triggered automatically for new newsletters (if enabled)
9. User can regenerate summaries for existing items

## Tasks / Subtasks
- [ ] Create AI summarization service (AC: 2, 3, 6)
  - [ ] Integrate OpenAI API client
  - [ ] Design summarization prompt template
  - [ ] Implement content chunking for long newsletters
  - [ ] Add token counting and usage tracking
- [ ] Build summary caching system (AC: 3, 8)
  - [ ] Create summaries database table/model
  - [ ] Implement cache-first summary retrieval
  - [ ] Add cache invalidation for regeneration
  - [ ] Store summary metadata (model, tokens used, date)
- [ ] Develop user preference system (AC: 1, 6)
  - [ ] Add AI summary settings to user profile
  - [ ] Create usage limit tracking per user
  - [ ] Implement monthly token/request caps
  - [ ] Add billing tier integration for limits
- [ ] Create summary UI components (AC: 4, 5, 9)
  - [ ] Build summary toggle button for newsletter items
  - [ ] Design summary display component (headline + bullets)
  - [ ] Add loading states for summary generation
  - [ ] Create regenerate summary functionality
- [ ] Implement automatic summarization (AC: 8)
  - [ ] Integrate with newsletter ingestion pipeline
  - [ ] Create background job for summary generation
  - [ ] Add queue processing for summary requests
  - [ ] Implement retry logic for failed generations
- [ ] Add error handling and fallbacks (AC: 7)
  - [ ] Log summarization failures with context
  - [ ] Display user-friendly error messages
  - [ ] Implement rate limit handling
  - [ ] Add fallback for API unavailability
- [ ] Create summary management endpoints (AC: 2, 9)
  - [ ] Build `/items/:id/summarize` POST endpoint
  - [ ] Add summary retrieval in feed API
  - [ ] Implement summary deletion/regeneration
  - [ ] Add bulk summarization endpoints

## Dev Notes

### Previous Story Insights
From Stories 1.1-1.6:
- Newsletter content is parsed and cleaned, ready for summarization
- User authentication and preferences system established
- Background job processing patterns implemented
- Dashboard displays newsletter items with metadata

### Data Models
From architecture documents:
- **Items**: Newsletter content for summarization input [Source: architecture/data-model-simplified.md]
- **Summaries**: Store generated summaries with metadata [Source: architecture/data-model-simplified.md]
- **Users**: User preferences and usage tracking [Source: architecture/data-model-simplified.md]
- **Jobs**: Background processing for summary generation [Source: architecture/data-model-simplified.md]

### API Specifications
From architecture documents:
- `POST /items/:id/summarize` - Generate summaries [Source: architecture/api-examples.md]
- Summary data integrated into existing feed endpoints [Source: architecture/core-components.md]

### Component Specifications
From architecture documents:
- **Summarization**: GPT-based headline + 3-bullet summary [Source: architecture/core-components.md]
- **Background Jobs**: Async jobs, cache by hash+model [Source: architecture/summarization.md]
- **Web App (React/Tailwind)**: Summary toggle and display [Source: architecture/core-components.md]
- **API (Node/Express)**: Summary endpoints and processing [Source: architecture/core-components.md]

### File Locations
Based on established patterns:
- **AI services**: `/src/services/ai/` (summaryService.js, openaiClient.js)
- **Summary routes**: `/src/routes/summaries.js`
- **Summary workers**: `/src/workers/summaryProcessor.js`
- **Summary models**: `/src/models/Summary.js`
- **Frontend components**: `/src/components/summaries/` (SummaryToggle.jsx, SummaryDisplay.jsx)
- **AI configuration**: `/src/config/ai.js` (OpenAI API keys, prompts)

### Technical Constraints
From architecture documents:
- **Summarization**: Async jobs, prompt for title + 3 bullets [Source: architecture/summarization.md]
- **Performance**: Chunk long content, cache by hash+model [Source: architecture/summarization.md]
- **Usage Limits**: Cap tokens and requests per user [Source: architecture/summarization.md]
- **Background Processing**: Queue-based async processing [Source: architecture/core-components.md]

### Testing Strategy
**Testing Framework Requirements:**
- **Backend Testing**: Jest + Supertest for summary endpoints
- **AI Testing**: Mock OpenAI API responses for consistent testing
- **Worker Testing**: Test async summary generation jobs
- **Frontend Testing**: Jest + React Testing Library for summary UI

**Required Test Coverage:**
- **Unit Tests**: Summary generation, prompt templates, token counting
- **Integration Tests**: End-to-end summarization workflow
- **Component Tests**: Summary toggle and display components
- **API Tests**: Summary endpoints and error handling

**Specific Test Scenarios:**
- Generate summary with proper headline and bullets format
- Handle long content with chunking strategy
- Respect user token limits and caps
- Cache and retrieve summaries efficiently
- Display summaries in dashboard correctly
- Handle OpenAI API failures gracefully
- Process automatic summarization for new newsletters
- Regenerate summaries when requested
- Track and enforce usage limits per user
- Handle rate limiting from OpenAI API

**Test File Locations:**
- **AI service tests**: `/src/services/ai/__tests__/`
- **Summary route tests**: `/src/routes/__tests__/summaries.test.js`
- **Worker tests**: `/src/workers/__tests__/summaryProcessor.test.js`
- **Frontend component tests**: `/src/components/summaries/__tests__/`
- **Integration tests**: `/tests/integration/ai-summarization.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | Initial story creation with comprehensive testing guidance | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be populated here*