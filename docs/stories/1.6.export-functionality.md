# Story 1.6: Export Functionality

## Status
Draft

## Story
**As a** user,
**I want** to export newsletter items to Markdown, Notion, or CSV formats,
**so that** I can use the content in my preferred tools and workflows.

## Acceptance Criteria
1. User can select multiple newsletter items for export
2. System supports export to Markdown format (sync operation)
3. System supports export to CSV format (sync operation)  
4. System supports export to Notion via API (async operation)
5. User receives downloadable file for Markdown/CSV exports
6. User receives confirmation when Notion export completes
7. Export includes metadata (title, source, date, URL)
8. User can choose date range for bulk exports
9. Export operations handle large datasets without timeout

## Tasks / Subtasks
- [ ] Create export selection interface (AC: 1, 8)
  - [ ] Add checkbox selection to newsletter items
  - [ ] Build bulk selection controls (select all, clear all)
  - [ ] Create date range picker for export filtering
  - [ ] Add export format selection modal/dropdown
- [ ] Implement Markdown export (AC: 2, 5, 7)
  - [ ] Create Markdown formatter service
  - [ ] Generate structured Markdown with metadata headers
  - [ ] Handle images and links in Markdown format
  - [ ] Create downloadable file generation
- [ ] Build CSV export functionality (AC: 3, 5, 7)
  - [ ] Create CSV formatter service
  - [ ] Define CSV column structure (title, content, source, date, etc.)
  - [ ] Handle text escaping and special characters
  - [ ] Generate downloadable CSV files
- [ ] Develop Notion API integration (AC: 4, 6, 7)
  - [ ] Set up Notion API credentials and workspace connection
  - [ ] Create Notion page/database creation service
  - [ ] Implement async export job for Notion
  - [ ] Add Notion export status tracking and notifications
- [ ] Create export API endpoints (AC: 2, 3, 4, 9)
  - [ ] Build `/exports` POST endpoint for initiating exports
  - [ ] Add export job status tracking endpoints
  - [ ] Implement file download endpoints for sync exports
  - [ ] Add pagination for large export operations
- [ ] Build export UI components (AC: 1, 5, 6, 8)
  - [ ] Create export modal with format selection
  - [ ] Add progress indicators for async exports
  - [ ] Build export history/status page
  - [ ] Implement download buttons and success notifications
- [ ] Add export job processing (AC: 4, 6, 9)
  - [ ] Create background workers for async exports
  - [ ] Implement job queue for export operations
  - [ ] Add retry logic for failed exports
  - [ ] Create export completion notifications

## Dev Notes

### Previous Story Insights
From Stories 1.1-1.5:
- Database models for Items with parsed content available
- Background job processing patterns established
- User authentication and source management implemented
- Clean, parsed content ready for export formatting

### Data Models
From architecture documents:
- **Items**: Newsletter content with parsed text and metadata [Source: architecture/data-model-simplified.md]
- **Exports**: Track export jobs and status [Source: architecture/data-model-simplified.md]
- **Jobs**: Background processing for async exports [Source: architecture/data-model-simplified.md]
- **Users**: User preferences for export formats [Source: architecture/data-model-simplified.md]

### API Specifications
From architecture documents:
- `POST /exports` - Create export jobs [Source: architecture/api-examples.md]
- Export endpoints extend existing API patterns [Source: architecture/core-components.md]
- File download endpoints for sync exports

### Component Specifications
From architecture documents:
- **Exporters**: Markdown/CSV (sync), Notion (async jobs) [Source: architecture/core-components.md]
- **Background Jobs**: Queue-based workers for export processing [Source: architecture/core-components.md]
- **Web App (React/Tailwind)**: Export interface and progress tracking [Source: architecture/core-components.md]
- **API (Node/Express)**: Export endpoints and file serving [Source: architecture/core-components.md]

### File Locations
Based on established patterns:
- **Export services**: `/src/services/exports/` (markdownExporter.js, csvExporter.js, notionExporter.js)
- **Export routes**: `/src/routes/exports.js`
- **Export workers**: `/src/workers/exportProcessor.js`
- **Export utilities**: `/src/utils/exports/` (fileGenerator.js, formatters.js)
- **Frontend components**: `/src/components/exports/` (ExportModal.jsx, ExportHistory.jsx)
- **Export configuration**: `/src/config/exports.js` (Notion API keys, file paths)

### Technical Constraints
From architecture documents:
- **Exports**: Markdown/CSV sync, Notion API async [Source: architecture/exports.md]
- **Performance**: Handle large exports without timeout [Source: architecture/performance-scaling.md]
- **Background Jobs**: Queue-based processing [Source: architecture/core-components.md]
- **Storage**: Temporary file storage for downloads [Source: architecture/core-components.md]

### Testing Strategy
**Testing Framework Requirements:**
- **Backend Testing**: Jest + Supertest for export endpoints
- **Export Testing**: Mock file generation and Notion API calls
- **Worker Testing**: Test async export job processing
- **Frontend Testing**: Jest + React Testing Library for export UI

**Required Test Coverage:**
- **Unit Tests**: Export formatters, file generators, API integrations
- **Integration Tests**: End-to-end export workflows
- **Component Tests**: Export selection and progress UI
- **API Tests**: Export endpoints and file downloads

**Specific Test Scenarios:**
- Generate Markdown export with proper formatting
- Create CSV export with correct column structure
- Notion API integration and page creation
- Bulk export with date range filtering
- Large dataset export performance
- Export job status tracking and notifications
- File download functionality
- Export error handling and retry logic
- Export UI selection and progress feedback

**Test File Locations:**
- **Export service tests**: `/src/services/exports/__tests__/`
- **Export route tests**: `/src/routes/__tests__/exports.test.js`
- **Worker tests**: `/src/workers/__tests__/exportProcessor.test.js`
- **Frontend component tests**: `/src/components/exports/__tests__/`
- **Integration tests**: `/tests/integration/export-flow.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | Initial story creation with comprehensive testing guidance | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be populated here*