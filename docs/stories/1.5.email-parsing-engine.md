# Story 1.5: Email Parsing & Normalization Engine

## Status
Draft

## Story
**As a** user,
**I want** email bodies parsed cleanly with no headers/footers/ads,
**so that** I only see the actual newsletter content without noise.

## Acceptance Criteria
1. System extracts main content from HTML emails using readability algorithms
2. Headers, footers, unsubscribe links, and ads are automatically removed
3. Email content is sanitized to prevent XSS and security issues
4. Links are normalized and made clickable in the dashboard
5. Images are processed and made accessible (with fallback text)
6. Text emails are converted to readable HTML format
7. Content extraction works across different newsletter formats/providers
8. Failed parsing attempts are logged and fallback to raw content
9. Parsing performance meets <2s requirement per email

## Tasks / Subtasks
- [ ] Implement core parsing engine (AC: 1, 7, 9)
  - [ ] Integrate Mozilla Readability library
  - [ ] Create email content extractor service
  - [ ] Add support for various HTML structures
  - [ ] Implement performance monitoring for parsing times
- [ ] Build content cleaning system (AC: 2, 3)
  - [ ] Create header/footer detection algorithms
  - [ ] Remove unsubscribe links and legal footers
  - [ ] Strip advertisement content and tracking pixels
  - [ ] Implement HTML sanitization (DOMPurify or similar)
- [ ] Develop link normalization (AC: 4)
  - [ ] Convert relative URLs to absolute URLs
  - [ ] Clean tracking parameters from links
  - [ ] Ensure links are clickable and secure
  - [ ] Add link validation and safety checks
- [ ] Handle image processing (AC: 5)
  - [ ] Extract and validate image sources
  - [ ] Generate alt text for images without descriptions
  - [ ] Implement image lazy loading for performance
  - [ ] Add fallback for broken or inaccessible images
- [ ] Support text email conversion (AC: 6)
  - [ ] Detect plain text emails
  - [ ] Convert text to HTML with proper formatting
  - [ ] Preserve line breaks and paragraph structure
  - [ ] Handle special characters and encoding
- [ ] Add error handling and fallbacks (AC: 8)
  - [ ] Log parsing failures with email metadata
  - [ ] Implement fallback to raw content display
  - [ ] Add retry logic for temporary parsing failures
  - [ ] Create debugging tools for problematic emails
- [ ] Integrate with existing systems (AC: 1-9)
  - [ ] Connect to email ingestion pipeline from Stories 1.1-1.2
  - [ ] Store parsed content in Items database model
  - [ ] Integrate with deduplication system
  - [ ] Update background job workers to use parsing engine

## Dev Notes

### Previous Story Insights
From Stories 1.1-1.3:
- Email ingestion pipelines established (OAuth, Forwarding, RSS)
- Database models for Items with content fields ready
- Background job processing patterns implemented
- Performance requirements (<2s) established

From Story 1.4:
- Dashboard expects clean, formatted content for display
- Search functionality depends on properly parsed text content

### Data Models
From architecture documents:
- **Items**: Store both raw and parsed content [Source: architecture/data-model-simplified.md]
- **Jobs**: Track parsing job status and failures [Source: architecture/data-model-simplified.md]
- Content hash generation for deduplication [Source: architecture/deduplication.md]

### API Specifications
Content parsing integrates with existing ingestion APIs rather than creating new endpoints.
Background processing extends existing job queue patterns [Source: architecture/core-components.md].

### Component Specifications
From architecture documents:
- **Parsing/Normalization**: Extract main text, remove ads, canonicalize links [Source: architecture/parsing-normalization.md]
- **Background Jobs**: Queue-based workers for parsing operations [Source: architecture/core-components.md]
- **Storage**: Store both raw (S3/GCS) and parsed (Postgres) content [Source: architecture/core-components.md]

### File Locations
Based on established patterns:
- **Core parsing engine**: `/src/services/parsing/` (contentExtractor.js, htmlSanitizer.js)
- **Parsing workers**: `/src/workers/contentParser.js`
- **Parsing utilities**: `/src/utils/parsing/` (readability.js, linkNormalizer.js, imageProcessor.js)
- **Parsing middleware**: `/src/middleware/parsing.js`
- **Parser configuration**: `/src/config/parsing.js`
- **Parsing tests**: `/src/services/parsing/__tests__/`

### Technical Constraints
From architecture documents:
- **Performance**: Parse < 2s per email on average [Source: architecture/performance-scaling.md]
- **Security**: Sanitize content to prevent XSS [Source: architecture/security-compliance.md]
- **Parsing**: MIME decode → HTML part → sanitize → Readability extract [Source: architecture/parsing-normalization.md]
- **Storage**: Raw content in object store, parsed in Postgres [Source: architecture/core-components.md]
- **Deduplication**: Generate normalized hash after parsing [Source: architecture/deduplication.md]

### Testing Strategy
**Testing Framework Requirements:**
- **Backend Testing**: Jest for parsing engine unit tests
- **Performance Testing**: Load testing for parsing speed requirements
- **Integration Testing**: End-to-end email processing pipeline
- **Security Testing**: XSS prevention and content sanitization

**Required Test Coverage:**
- **Unit Tests**: Content extraction, sanitization, link normalization
- **Integration Tests**: Full email processing pipeline with parsing
- **Performance Tests**: Parsing speed with various email sizes/formats
- **Security Tests**: XSS prevention, malicious content handling

**Specific Test Scenarios:**
- Extract main content from complex HTML newsletters
- Remove headers/footers from various newsletter providers
- Sanitize malicious HTML and JavaScript
- Normalize links and handle tracking parameters
- Process images and generate appropriate alt text
- Convert plain text emails to formatted HTML
- Handle parsing failures gracefully with fallbacks
- Meet <2s parsing performance requirement
- Process various newsletter formats (Substack, Mailchimp, etc.)

**Test File Locations:**
- **Core parsing tests**: `/src/services/parsing/__tests__/`
- **Worker tests**: `/src/workers/__tests__/contentParser.test.js`
- **Utility tests**: `/src/utils/parsing/__tests__/`
- **Integration tests**: `/tests/integration/email-parsing.test.js`
- **Performance tests**: `/tests/performance/parsing-speed.test.js`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | Initial story creation with comprehensive testing guidance | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be populated here*